

RDB是Redis用来进行持久化的一种方式，把当前内存中的数据集快照写入磁盘，也就是 Snapshot 快照，恢复时将快照文件直接读到内存里



RDB 有两种触发方式，分别是自动触发和手动触发







### 自动触发

自动触发只需在配置文件中添加 save m n 即可，save m n表示m秒内数据集存在n次修改时，自动触发bgsave，以下是默认配置：

```shell
# 表示900 秒内如果至少有 1 个 key 的值变化，则保存
save 900 1 

# 表示300 秒内如果至少有 10 个 key 的值变化，则保存
save 300 10 

# 表示60 秒内如果至少有 10000 个 key 的值变化，则保存
save 60 1000
```



如果只是用Redis的缓存功能，不需要持久化，可以注释掉所有的 save 行或者使用空字符串save ""来停用保存功能，其他相关配置参数：

- [ ] stop-writes-on-bgsave-error ：默认值为yes，当启用了RDB且最后一次后台保存数据失败，Redis是否停止接收数据

- [ ] rdbcompression ：默认值是yes，对于存储到磁盘中的快照设置是否进行压缩存储，若为yes redis会采用LZF算法进行压缩，若不想消耗CPU来进行压缩的话，可以设置为关闭此功能，但是存储在磁盘上的快照会比较大

- [ ] rdbchecksum ：默认值是yes，在存储快照后，还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，若希望获取到最大的性能提升，可以关闭此功能

- [ ] dbfilename ：设置快照的文件名，默认是 dump.rdb

- [ ] dir：设置快照文件的存放路径，这个配置项一定是个目录，**默认是和当前配置文件保存在同一目录**



通过在配置文件中配置的 save 方式，当实际操作满足该配置形式时就会进行 RDB 持久化，将当前的内存快照保存在 dir 配置的目录中，文件名由配置的 dbfilename 决定









### 手动触发

手动触发Redis进行RDB持久化的命令有save 和 bgsave两个命令



##### save

该命令会阻塞当前Redis服务器，执行save命令期间，Redis不能处理其他命令，直到RDB过程完成为止，显然该命令对于内存比较大的实例会造成长时间阻塞，为了解决此问题，Redis提供了第二种方式



##### bgsave

执行该命令时，Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求，具体操作是Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束，阻塞只发生在fork阶段，一般时间很短



基本上 Redis 内部所有的RDB操作都是采用 bgsave 命令，执行执行 flush all 命令，也会产生dump.rdb文件，但里面是空的，无意义









### 数据恢复

将备份文件 dump.rdb 移动到 redis 安装目录并启动服务，redis就会自动加载文件数据至内存，Redis 服务器在载入 RDB 文件期间，会一直处于阻塞状态，直到载入工作完成为止



使用 **config get dir** 命令可以获取 redis 的安装目录

 







### 停止RDB

 配置文件中注释掉save行，将 save 置为 ""，用一个空字符串来实现停用：**save ""**，也可以通过命令 ` redis-cli config set save " "`  停止使用RDB









### RDB 的优缺势

优势：

- [ ] RDB是一个非常紧凑的文件，保存了redis 在某个时间点上的数据集，非常适合用于进行备份和灾难恢复

- [ ] 生成RDB文件时，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作

- [ ] RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快



劣势：

- [ ] RDB方式数据没办法做到实时持久化/秒级持久化，因为每次运行bgsave都要执行fork操作创建子进程，内存中的数据被克隆了一份，属于重量级操作，频繁执行会影响性能

- [ ] 版本不兼容：RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis服务无法兼容新版RDB格式的问题

- [ ] 数据有丢失：在一定间隔时间做一次备份，如果redis意外down掉，就会丢失最后一次快照后的所有修改

 



[**演示**](https://www.cnblogs.com/itdragon/p/7906481.html)

**SHUTDOWN 和 FLUSH ALL 命令都会触发RDB快照**，其他命令：

```shell
# 匹配数据库中所有 key
keys * 

# 阻塞触发RDB快照，使其备份数据
save 

# 清空整个 Redis 服务器的数据，几乎不用
FLUSHALL 

# 关机走人很少用
SHUTDOWN 
```



