### 修改配置文件

将redis.conf 配置文件复制三份，通过修改端口分别模拟三台Redis服务器

```shell
cp redis.conf redis_6380.conf
cp redis.conf redis_6381.conf
cp redis.conf redis_6382.conf
```



分别修改三个配置文件中的以下内容，以6380为例：

```shell
# 后台启动
daemonize yes

# 配置PID文件路径 pidfile

/var/redis/run/redis_6380.pid

port 6380

logfile "6380.log"

dbfilename dump_6380.rdb
```



分别启动三个服务

```shell
redis-server ./redis_6380.conf
redis-server ./redis_6381.conf
redis-server ./redis_6382.conf

# 查看是否成功启动
ps -ef | grep redis

# 进入客户端
redis-cli -p 6370
redis-cli -p 6381
redis-cli -p 6382
```







### 设置主从关系

通过 info replication 命令查看节点角色，此时三个节点都是Master 角色，选择6381端口和6382端口，执行命令`SLAVEOF 127.0.0.1 6380`，再次使用info replication 命令，可以发现 只有 6380 为Master，其他两个为 Slave



通过命令来设置主从关系，一旦服务重启，那么角色关系将不复存在，想要永久的保存这种关系，可以通过配置redis.conf 文件来配置

```shell
slaveof 127.0.0.1 6379
```





### 测试主从关系

##### 增量复制

在Master在执行set命令，Slave上通过get命令可以获取到相应的值



##### 全量复制

通过执行 SLAVEOF 127.0.0.1 6380，主节点 63780以前还存在一些 key，执行命令之后，从节点会将以前的信息全都复制过来



##### 读写分离

主节点能够执行写命令，从节点默认不能执行写命令，原因是在配置文件 redis_6381.conf 中对于 **slave-read-only** 的配置，默认为yes，若修改为no之后，从机也可以执行写操作，但是从节点写命令的数据从节点或者主节点都不能获取



##### 主节点宕机

Master 宕机后，两个Slave的角色不会变，当重启主节点之后，改节点扮演的还是Master角色











### 主从复制原理

Redis的复制功能分为同步sync和命令传播command propagate两个操作，通过同步操作以及命令传播功能，能够很好的保证了主从一致的特性



##### 旧版同步

当从节点发出 SLAVEOF 命令，要求从服务器复制主服务器时，从服务器通过向主服务器发送 SYNC 命令来完成，该命令执行步骤：

- [ ] 从服务器向主服务器发送 SYNC 命令

- [ ] 收到 SYNC 命令的主服务器执行 BGSAVE 命令，在后台生成一个 RDB 文件，并使用一个缓冲区记录从开始执行的所有写命令

- [ ] 当主服务器的 BGSAVE 命令执行完毕时，主服务器会将 BGSAVE 命令生成的 RDB 文件发送给从服务器

- [ ] 主服务器将缓冲区的所有写命令也发送给从服务器，从服务器执行相应命令





##### 命令传播

当同步操作完成之后，主服务器会进行相应的修改命令，这时候从服务器和主服务器状态就会不一致

- [ ] 为了让主服务器和从服务器保持状态一致，主服务器需要对从服务器执行命令传播操作，主服务器会将自己的写命令发送给从服务器执行

- [ ] 从服务器执行相应的命令之后，主从服务器状态继续保持一致











### FAQ

> 如果从服务器在同步主服务器期间，突然断开了连接，而这时候主服务器进行了一些写操作，这时候从服务器恢复连接，如果在进行同步，那么就必须将主服务器从新生成一个RDB文件，然后给从服务器加载，这样虽然能够保证一致性，但是其实断开连接之前主从服务器状态是保持一致的，不一致的是从服务器断开连接时主服务器执行了一些写命令，那么从服务器恢复连接后能不能只要断开连接的哪些写命令，而不是整个RDB快照呢？



同步操作其实是一个非常耗时的操作，主服务器需要先通过 BGSAVE 命令来生成一个 RDB 文件，然后需要将该文件发送给从服务器，从服务器接收该文件之后，接着加载该文件，并且加载期间，从服务器是无法处理其他命令的



为了解决这个问题，Redis从2.8版本之后，使用了新的同步命令 PSYNC 来代替 SYNC 命令，该命令的部分重同步功能用于处理断线后重复制的效率问题，也就是说当从服务器在断线后重新连接主服务器时，主服务器只将断开连接后执行的写命令发送给从服务器，从服务器只需要接收并执行这些写命令即可保持主从一致









### 主从复制缺点

主从复制虽然解决了主节点的单点故障问题，但是由于所有的写操作都是在 Master 节点上操作，然后同步到 Slave 节点，那么同步就会有一定的延时，当系统很繁忙的时候，延时问题就会更加严重，而且会随着从节点slave的增多而愈加严重

